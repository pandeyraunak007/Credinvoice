name: ğŸš€ Deploy to Oracle Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ Deploy to server
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "export GROQ_API_KEY='$GROQ_API_KEY' && bash -s" << 'ENDSSH'
            set -e

            cd ~/Credinvoice-main
            
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            
            echo "ğŸ“¦ Updating backend..."
            cd backend

            # Update GROQ_API_KEY in .env if secret is set
            if [ -n "$GROQ_API_KEY" ]; then
              if grep -q "^GROQ_API_KEY=" .env 2>/dev/null; then
                sed -i "s|^GROQ_API_KEY=.*|GROQ_API_KEY=$GROQ_API_KEY|" .env
              else
                echo "GROQ_API_KEY=$GROQ_API_KEY" >> .env
              fi
              echo "âœ“ GROQ_API_KEY configured"
            fi

            npm ci
            npm run build
            npx prisma generate
            npx prisma db push --skip-generate
            
            echo "ğŸ“¦ Updating frontend..."
            cd ../frontend
            npm ci
            npm run build
            
            echo "ğŸ”„ Restarting services..."
            pm2 restart credinvoice-api
            pm2 save
            
            echo "âœ… Deployment complete!"
          ENDSSH

      - name: ğŸ¥ Health Check
        run: |
          sleep 10
          curl -f http://${{ secrets.SERVER_HOST }} || exit 1
          echo "âœ… Site is live!"
